# [기술 문서] Kocom 에어컨 제어 패킷 로직 아키텍처 (v2.2.4)

이 문서는 v2.2.4 버전에서 완성된 **조용한 재연결(Silent Reconnection)** 및 **Deep Silence** 아키텍처를 다룹니다.

---

### 1. 문제 정의: 침묵의 역설 (The Paradox of Silence)

v2.2.3에서 모든 하트비트와 폴링을 제거하여 완벽한 침묵(Deep Silence)을 구현했습니다. 그러나 역설적으로 이 '침묵'이 새로운 소음의 원인이 되었습니다.

1.  **침묵 (Silence):** 데이터 전송 없음.
2.  **타임아웃 (Timeout):** EW11 또는 서버가 장시간(60s~5min) 유휴 상태를 '연결 끊김'으로 오인하여 소켓을 닫음.
3.  **재연결 (Reconnect):** `AsyncConnection`이 연결 끊김을 감지하고 재연결 시도.
4.  **폭풍 (Storm):** 재연결 성공 직후 `_force_discovery()`가 실행되어 20개 이상의 쿼리 패킷 전송.
5.  **비프음 (Beep):** 주기적인 연결 끊김 -> 주기적인 탐색 폭풍 -> **주기적인 비프음 발생.**

---

### 2. 해결책: 조용한 재연결 (Silent Reconnection)

v2.2.4에서는 **재연결 시 기기 탐색(Discovery)을 수행하지 않습니다.**

| 상황 | 기존 동작 (v2.2.3) | 개선된 동작 (v2.2.4) |
| :--- | :--- | :--- |
| **초기 부팅** | 전체 기기 탐색 실행 | 전체 기기 탐색 실행 |
| **네트워크 재연결** | 전체 기기 탐색 실행 (Beep Storm) | **아무것도 하지 않음 (Silent)** |
| **기기 상태 동기화** | 즉시 동기화됨 | 사용자 제어 시 또는 월패드 상태 변경 시 자연스럽게 동기화됨 |

---

### 3. 상태 동기화 전략 (Synchronization Strategy)

재연결 시 탐색을 하지 않아도 시스템이 정상 작동하는 이유는 다음과 같습니다.

1.  **상태 보존:** 짧은 연결 끊김(수 초~수 분) 동안 집안의 기기 상태(조명 ON/OFF 등)는 대부분 변하지 않습니다.
2.  **브로드캐스트 수신:** 월패드에서 물리적으로 스위치를 켜면 상태 변경 패킷이 브로드캐스트되므로, 연결만 되어 있다면 HA가 이를 수신하여 상태를 갱신합니다.
3.  **사용자 제어:** HA에서 제어 명령을 보내면 ACK를 통해 최신 상태가 즉시 반영됩니다.

---

### 4. 아키텍처 요약 (Architecture Summary)

v2.2.4는 **"연결은 끈질기게, 입은 무겁게"** 유지합니다.

*   **Socket/Serial:** 끊어지면 즉시 재연결을 시도합니다.
*   **Packet:** 재연결되어도 인사를 건네지 않습니다(No Discovery).
*   **Polling:** 묻지 않습니다(No Polling).
*   **Heartbeat:** 숨을 죽입니다(No Heartbeat).

이로써 어떠한 네트워크 환경에서도 에어컨 비프음이 발생하지 않는 구조를 완성했습니다.