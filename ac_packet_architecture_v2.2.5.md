# [기술 문서] Kocom 에어컨 제어 패킷 로직 아키텍처 (v2.2.5)

이 문서는 v2.2.5 버전에서 도입된 **게으른 탐색(Lazy Discovery)** 및 **무음 부팅(Zero-Beep Boot)** 아키텍처를 다룹니다.

---

### 1. 문제: 부팅 비프음 (The Boot Beep Problem)

v2.2.4까지는 "재연결" 시의 비프음은 해결했으나, **Home Assistant 재시작(부팅)** 또는 **통합 구성요소 리로드** 시에는 여전히 모든 기기를 탐색(Query)했습니다.
이때 에어컨(AC)과 난방기(Thermostat)는 쿼리 패킷(`0x39`, `0x36`)을 수신하면 "삑" 하는 비프음을 발생시키는 하드웨어 특성이 있습니다. 따라서 HA가 재시작될 때마다 집안 곳곳에서 비프음이 울리는 문제가 지속되었습니다.

---

### 2. 해결책: 게으른 탐색 (Lazy Discovery)

v2.2.5에서는 **민감한 기기(Sensitive Devices)**에 대해 자동 탐색을 수행하지 않습니다.

| 기기 타입 | 기존 (v2.2.4) | 개선 (v2.2.5) | 비고 |
| :--- | :--- | :--- | :--- |
| **조명 (Light)** | 부팅 시 자동 탐색 | **부팅 시 자동 탐색** | 비프음 없음, 즉시 사용 가능 |
| **환기 (Ventilation)** | 부팅 시 자동 탐색 | **부팅 시 자동 탐색** | 비프음 없음 |
| **에어컨 (AC)** | 부팅 시 자동 탐색 (Beep!) | **탐색 안 함 (Lazy)** | **비프음 제거됨** |
| **난방 (Thermostat)** | 부팅 시 자동 탐색 | **탐색 안 함 (Lazy)** | **비프음 제거됨** |

---

### 3. 기기 등록 매커니즘 (Registration Mechanism)

에어컨과 난방기는 부팅 직후 HA 엔티티 리스트에 즉시 나타나지 않을 수 있습니다(이전 상태 복원 기능이 있으면 나타남).
이들은 다음 두 가지 상황에서 등록 및 상태 갱신이 이루어집니다.

1.  **Passive Registration (수동적 등록):**
    *   사용자가 월패드에서 에어컨을 켜거나 온도를 조절함.
    *   월패드가 변경된 상태를 RS485 버스에 브로드캐스트함.
    *   HA가 이를 수신하여 즉시 엔티티를 생성하고 상태를 업데이트함.

2.  **Active Registration (능동적 등록):**
    *   사용자가 HA 대시보드(이전 상태로 복원된 엔티티)에서 제어 명령(온도 변경 등)을 보냄.
    *   게이트웨이가 제어 패킷을 전송함.
    *   AC가 ACK(현재 상태)를 응답함.
    *   HA가 이를 수신하여 엔티티 상태를 확정함.

---

### 4. 아키텍처 요약 (Architecture Summary)

v2.2.5는 **"건드리지 않으면 소리 내지 않는다"**는 원칙을 확립했습니다.

*   **Boot:** 조명/환기만 조용히 확인합니다.
*   **Reconnect:** 침묵합니다.
*   **Idle:** 침묵합니다.
*   **Control:** 사용자가 명령할 때만 통신합니다.

이로써 시스템의 모든 생명주기(부팅, 운영, 재연결)에서 에어컨 비프음이 발생할 가능성을 구조적으로 차단했습니다.
