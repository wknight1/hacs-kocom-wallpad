# Kocom Wallpad Integration (RS485)

[![HACS Badge](https://img.shields.io/badge/HACS-Custom-orange.svg)](https://github.com/hacs/integration)
[![Version](https://img.shields.io/github/v/release/wknight1/hacs-kocom-wallpad)](https://github.com/wknight1/hacs-kocom-wallpad/releases)
[![Maintainer](https://img.shields.io/badge/maintainer-wknight1-blue)](https://github.com/wknight1)

ì½”ì½¤(Kocom) ì›”íŒ¨ë“œì˜ RS485 í”„ë¡œí† ì½œì„ ë¶„ì„í•˜ì—¬ Home Assistantì— í†µí•©í•˜ëŠ” ì»¤ìŠ¤í…€ ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.
EW11ê³¼ ê°™ì€ RS485-WiFi/Ethernet ê²Œì´íŠ¸ì›¨ì´ë¥¼ í†µí•´ í†µì‹ í•˜ë©°, ë†’ì€ ì‹ ë¢°ì„±ê³¼ ë¹ ë¥¸ ë°˜ì‘ ì†ë„ë¥¼ ëª©í‘œë¡œ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.

## ğŸŒŸ Key Features

*   **Zero-Copy RingBuffer:** ê³ ì„±ëŠ¥ ì›í˜• ë²„í¼(Ring Buffer)ë¥¼ ë„ì…í•˜ì—¬ íŒ¨í‚· íŒŒì‹± ì‹œ ë©”ëª¨ë¦¬ ì¬í• ë‹¹ì„ ìµœì†Œí™”í•˜ê³  CPU ì ìœ ìœ¨ì„ ë‚®ì·„ìŠµë‹ˆë‹¤.
*   **Smart Polling & Sync:** ì œì–´ ëª…ë ¹ ì†¡ì‹  ì§í›„ ìƒíƒœ ì¡°íšŒë¥¼ ìˆ˜í–‰í•˜ëŠ” 'ì¦‰ì‹œ ë™ê¸°í™”(Immediate Sync)' ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ëª…ë ¹ ìœ ì‹¤ì„ ë°©ì§€í•©ë‹ˆë‹¤.
*   **Resilient Self-Healing:** ê³µìœ ê¸° ì¬ë¶€íŒ… ë“± ë„¤íŠ¸ì›Œí¬ ì¥ì•  ë°œìƒ ì‹œ ì§€ìˆ˜ ë°±ì˜¤í”„ë¡œ ì¬ì—°ê²°ì„ ì‹œë„í•˜ë©°, ë³µêµ¬ ì§í›„ ëª¨ë“  ê¸°ê¸° ìƒíƒœë¥¼ ìë™ìœ¼ë¡œ ì¬íƒìƒ‰í•©ë‹ˆë‹¤.
*   **Active Keep-Alive:** 25ì´ˆ ìœ íœ´ ì‹œë§ˆë‹¤ ì„¸ì…˜ ìœ ì§€ íŒ¨í‚·ì„ ì „ì†¡í•˜ì—¬ TCP ì—°ê²°ì´ ëŠê¸°ëŠ” ê²ƒì„ ë°©ì§€í•˜ê³  ëª…ë ¹ ë°˜ì‘ ì†ë„ë¥¼ ìµœì í™”í–ˆìŠµë‹ˆë‹¤.
*   **Health Monitoring:** ì›”íŒ¨ë“œ ì‘ë‹µì„ ì‹¤ì‹œê°„ ê°ì‹œ(30ë¶„ íƒ€ì„ì•„ì›ƒ)í•˜ì—¬ ì „ì› ì¥ì•  ì‹œ ì—”í‹°í‹°ë¥¼ ìë™ìœ¼ë¡œ 'ì‚¬ìš© ë¶ˆê°€ëŠ¥(Unavailable)'ìœ¼ë¡œ ì „í™˜í•˜ì—¬ ìƒíƒœ ì˜¤ë³´ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
*   **Atomic Self-Healing:** `asyncio.Lock`ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì›ìì  ì¬ì—°ê²° ë¡œì§ìœ¼ë¡œ ì¤‘ë³µ ì—°ê²° ì‹œë„ë¥¼ ë°©ì§€í•˜ê³  ì•ˆì •ì ìœ¼ë¡œ í†µì‹ ì„ ë³µêµ¬í•©ë‹ˆë‹¤.

---

## ğŸ— System Architecture

### 1. Data Flow Sequence

Home Assistant ì‚¬ìš©ìê°€ ëª…ë ¹ì„ ë‚´ë ¸ì„ ë•Œ, ë‚´ë¶€ì ìœ¼ë¡œ ì–´ë–»ê²Œ ì²˜ë¦¬ë˜ëŠ”ì§€ ë³´ì—¬ì£¼ëŠ” ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ì…ë‹ˆë‹¤.

```mermaid
sequenceDiagram
    participant User as ğŸ‘¤ User (HA)
    participant GW as âš™ï¸ Gateway (Integration)
    participant Wallpad as ğŸ“Ÿ Wallpad (RS485)

    User->>GW: 1. Turn ON (Light)
    GW->>Wallpad: 2. Send HEX Command (0xAA 0x55...)
    Note over GW, Wallpad: Timeout: 1.0s (Retrying up to 3 times)
    Wallpad-->>GW: 3. ACK (Physical Signal)
    
    rect rgb(20, 50, 20)
        Note right of GW: âœ… Secure State Sync
        GW->>Wallpad: 4. Immediate Query (0x00)
        Wallpad-->>GW: 5. State Report (Status Packet)
    end
    
    GW->>User: 6. Update Entity State
```

### 2. Component Architecture

```mermaid
classDiagram
    class KocomGateway {
        +AsyncConnection conn
        +KocomController controller
        +EntityRegistry registry
        +sender_loop()
        +read_loop()
    }
    class KocomController {
        +RingBuffer rx_buf
        +feed(bytes)
        +generate_command()
    }
    class RingBuffer {
        +append(bytes)
        +peek(int)
        +find(bytes)
    }
    class DeviceState {
        +DeviceKey key
        +Platform platform
        +Any state
    }

    KocomGateway --> KocomController : Manages
    KocomController --> RingBuffer : Uses
    KocomGateway --> DeviceState : Updates
```

### 3. ì—ì–´ì»¨ ì œì–´ ìµœì í™”: ìƒíƒœ ë³´ì¡´í˜• íŒ¨í‚· ì¬êµ¬ì„± (State-Preserving)

v2.2.1 ë²„ì „ë¶€í„° ì ìš©ëœ ì—ì–´ì»¨ ì œì–´ ë¡œì§ì€ ë‹¨ìˆœíˆ ëª…ë ¹ë§Œ ë³´ë‚´ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, í˜„ì¬ì˜ ë””ë°”ì´ìŠ¤ ìƒíƒœë¥¼ ì›ìì ìœ¼ë¡œ ìœ ì§€í•˜ë©´ì„œ í•„ìš”í•œ ì†ì„±ë§Œ ë³€ê²½í•˜ëŠ” **'ìƒíƒœ ë³´ì¡´í˜•(State-Preserving)'** ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

#### **ê¸°ìˆ ì  ë°°ê²½**
ì—ì–´ì»¨ ì œì–´ íŒ¨í‚·(RS485)ì€ ì „ì›, ëª¨ë“œ, ì„¤ì • ì˜¨ë„, ë°”ëŒ ì„¸ê¸° ë“±ì´ í•˜ë‚˜ì˜ í˜ì´ë¡œë“œì— ë¬¶ì—¬ ì „ì†¡ë©ë‹ˆë‹¤. íŠ¹ì • ì†ì„±(ì˜ˆ: ì˜¨ë„)ë§Œ íŒ¨í‚·ì— ë‹´ì•„ ë³´ë‚¼ ê²½ìš°, ì›”íŒ¨ë“œê°€ ë‚˜ë¨¸ì§€ ì •ë³´(ì˜ˆ: ë°”ëŒ ì„¸ê¸°)ë¥¼ `0` í˜¹ì€ `ê¸°ë³¸ê°’`ìœ¼ë¡œ í•´ì„í•˜ì—¬ ê¸°ì¡´ ì„¤ì •ì´ í’€ë¦¬ê±°ë‚˜ ì—ì–´ì»¨ì—ì„œ ì˜¤ë¥˜ ë¹„í”„ìŒì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### **ê°œì„ ëœ ì œì–´ íë¦„**

```mermaid
graph TD
    A[ì‚¬ìš©ì: ì˜¨ë„ ì¡°ì ˆ 24ë„] --> B{í˜„ì¬ ìƒíƒœ ì¡°íšŒ}
    B --> C[Registry: ëª¨ë“œ=ëƒ‰ë°©, ë°”ëŒ=ê°•í’, ì˜¨ë„=26ë„]
    C --> D[íŒ¨í‚· í…œí”Œë¦¿ ìƒì„±]
    D --> E[ì˜¨ë„ í•„ë“œë§Œ 24ë¡œ ì—…ë°ì´íŠ¸]
    E --> F[ìµœì¢… íŒ¨í‚· êµ¬ì„±: ëƒ‰ë°©/ê°•í’/24ë„]
    F --> G[RS485 ì „ì†¡]
    G --> H[ì—ì–´ì»¨: ì„¤ì •ê°’ ìœ ì§€ ë° ì˜¨ë„ë§Œ ë³€ê²½]
```

#### **ì£¼ìš” ì´ì **
*   **ì„¤ì • ìœ ì§€:** ì˜¨ë„ë¥¼ ë°”ê¿¨ëŠ”ë° ë°”ëŒ ì„¸ê¸°ê°€ ê°‘ìê¸° ì•½í’ìœ¼ë¡œ ë³€í•˜ëŠ” ë“±ì˜ ë¶€ì‘ìš©ì´ ì—†ìŠµë‹ˆë‹¤.
*   **ë¹„í”„ìŒ ë°©ì§€:** ë¶ˆì™„ì „í•œ íŒ¨í‚·(ëª¨ë“  ê°’ì´ 0ì¸ íŒ¨í‚· ë“±) ì „ì†¡ì„ ë°©ì§€í•˜ì—¬ ì›”íŒ¨ë“œ ë° ì—ì–´ì»¨ì˜ ì˜¤ë™ì‘ ì•Œë¦¼(Beep)ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.
*   **ì„€ë„ìš° ë ˆì§€ìŠ¤íŠ¸ë¦¬(Shadow Registry) í™œìš©:** ì‹¤ì œ ë¬¼ë¦¬ íŒ¨í‚·ì´ ì˜¤ê¸° ì „ì´ë¼ë„ ë©”ëª¨ë¦¬ìƒì˜ ë§ˆì§€ë§‰ ìƒíƒœë¥¼ ì°¸ì¡°í•˜ì—¬ ê°€ì¥ ì •í™•í•œ ëª…ë ¹ì„ ìƒì„±í•©ë‹ˆë‹¤.

---

## ğŸš€ Advanced Setup Guide

### 1. EW11 Gateway Configuration
ì•ˆì •ì ì¸ í†µì‹ ì„ ìœ„í•´ EW11 ì„¤ì •ì„ ë‹¤ìŒê³¼ ê°™ì´ ê¶Œì¥í•©ë‹ˆë‹¤.

| Setting | Value | Description |
| :--- | :--- | :--- |
| **Baudrate** | `9600` | ì½”ì½¤ ì›”íŒ¨ë“œ í‘œì¤€ ì†ë„ |
| **Data Size** | `8` | 8 data bits |
| **Parity** | `None` | No parity |
| **Stop Bits** | `1` | 1 stop bit |
| **Flow Control** | `None` | íë¦„ ì œì–´ ì—†ìŒ |
| **Buffer Size** | `512` | íŒ¨í‚· ì²˜ë¦¬ ìµœì í™” ê°’ |
| **Gap Time** | `50ms` | íŒ¨í‚· ì¢…ë£Œ ê°ì§€ ì§€ì—° ì‹œê°„ |
| **Keep Alive** | `10s` | TCP ì—°ê²° ìœ ì§€ ê°„ê²© |
| **Timeout** | `30s` | ì†Œì¼“ ìë™ ì¢…ë£Œ íƒ€ì„ì•„ì›ƒ |

### 2. HACS Installation
1.  Home Assistantì˜ **HACS > Integrations** ë©”ë‰´ë¡œ ì´ë™í•©ë‹ˆë‹¤.
2.  ìš°ì¸¡ ìƒë‹¨ ë©”ë‰´(â‹®)ì—ì„œ **Custom repositories**ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
3.  Repository URLì— `https://github.com/wknight1/kocom-wallpad`ë¥¼ ì…ë ¥í•˜ê³ , ì¹´í…Œê³ ë¦¬ë¥¼ **Integration**ìœ¼ë¡œ ì„ íƒí•©ë‹ˆë‹¤.
4.  **Kocom Wallpad**ë¥¼ ê²€ìƒ‰í•˜ì—¬ ì„¤ì¹˜í•˜ê³  HAë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤.

### 3. Integration Configuration
1.  **ì„¤ì • > ê¸°ê¸° ë° ì„œë¹„ìŠ¤ > í†µí•© êµ¬ì„±ìš”ì†Œ ì¶”ê°€** ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.
2.  **Kocom Wallpad**ë¥¼ ê²€ìƒ‰í•˜ì—¬ ì„ íƒí•©ë‹ˆë‹¤.
3.  EW11ì˜ **IP ì£¼ì†Œ**ì™€ **í¬íŠ¸(ì˜ˆ: 8899)**ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.

---

## ğŸ“‚ Project Structure

```text
custom_components/kocom_wallpad/
â”œâ”€â”€ gateway.py      # í†µì‹  ë£¨í”„, ì¬ì‹œë„ ë¡œì§, ì—”í‹°í‹° ë ˆì§€ìŠ¤íŠ¸ë¦¬ ê´€ë¦¬
â”œâ”€â”€ controller.py   # íŒ¨í‚· íŒŒì‹±(RingBuffer), ëª…ë ¹ ìƒì„±, ì¥ì¹˜ë³„ í•¸ë“¤ëŸ¬
â”œâ”€â”€ transport.py    # Asyncio ê¸°ë°˜ TCP/Serial ì—°ê²° ê´€ë¦¬
â”œâ”€â”€ const.py        # ìƒìˆ˜ ì •ì˜ (ì¬ì‹œë„ íšŸìˆ˜, íƒ€ì„ì•„ì›ƒ ë“±)
â”œâ”€â”€ models.py       # ë°ì´í„° ëª¨ë¸ (DeviceKey, DeviceState)
â””â”€â”€ ... (platforms) # light, climate, fan, sensor ë“±
```

---

## ğŸ”§ Troubleshooting & FAQ

### Q1. 'int object is not callable' ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.
êµ¬í˜• `RingBuffer` êµ¬í˜„ì²´ì—ì„œ `__len__` ë©”ì„œë“œì— `@property` ë°ì½”ë ˆì´í„°ë¥¼ ì˜ëª» ì‚¬ìš©í•˜ì—¬ ë°œìƒí–ˆë˜ ë¬¸ì œì…ë‹ˆë‹¤. í˜„ì¬ ë²„ì „(v2.0.5 ì´ìƒ)ì—ì„œëŠ” í•´ë‹¹ ë¡œì§ì´ ìˆ˜ì •ë˜ì—ˆìœ¼ë©°, `len()` í•¨ìˆ˜ í˜¸ì¶œ ì‹œ ì •ìƒì ìœ¼ë¡œ ë²„í¼ í¬ê¸°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

### Q2. ëª…ë ¹ì„ ë³´ëƒˆëŠ”ë° ë°˜ì‘ì´ ëŠë¦¬ê±°ë‚˜ ì”¹í™ë‹ˆë‹¤.
ì½”ì½¤ ì›”íŒ¨ë“œ ë„¤íŠ¸ì›Œí¬ëŠ” 9600bpsë¡œ ë§¤ìš° ëŠë¦½ë‹ˆë‹¤. ë˜í•œ EW11ì˜ ë¬´ì„  ë„¤íŠ¸ì›Œí¬ ìƒíƒœì— ë”°ë¼ ì§€ì—°ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
*   ë³¸ í†µí•© êµ¬ì„±ìš”ì†ŒëŠ” **ìµœëŒ€ 3íšŒ ì¬ì‹œë„**ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
*   ëª…ë ¹ í›„ ìƒíƒœê°€ ì¦‰ì‹œ ë°˜ì˜ë˜ì§€ ì•Šë”ë¼ë„, **ê°•ì œ ìƒíƒœ ë™ê¸°í™”(Immediate Sync)** íŒ¨í‚·ì´ í›„ì†ìœ¼ë¡œ ì „ì†¡ë˜ì–´ ìƒíƒœë¥¼ ë³´ì •í•©ë‹ˆë‹¤.

### Q3. ì¼ë¶€ ê¸°ê¸°ê°€ ë°œê²¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
ì›”íŒ¨ë“œ ëª¨ë¸ë§ˆë‹¤ ì§€ì›í•˜ëŠ” íŒ¨í‚·ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ì˜ **ë””ë²„ê·¸ ë¡œê¹… ê°€ì´ë“œ**ë¥¼ ë”°ë¼ ë¡œê·¸ë¥¼ ì¶”ì¶œí•˜ì—¬ ì œë³´í•´ ì£¼ì„¸ìš”.

---

## ğŸ” Debugging Guide (ë¡œê¹… ê°€ì´ë“œ)

ë¬¸ì œê°€ ë°œìƒí•  ê²½ìš°, ë‹¤ìŒ ë°©ë²• ì¤‘ í•˜ë‚˜ë¡œ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë°©ë²• 1: UIë¥¼ í†µí•œ ê°„í¸ í™œì„±í™” (ê¶Œì¥)
1.  **ì„¤ì • > ê¸°ê¸° ë° ì„œë¹„ìŠ¤ > í†µí•© êµ¬ì„±ìš”ì†Œ** ë©”ë‰´ë¡œ ì´ë™í•©ë‹ˆë‹¤.
2.  **Kocom Wallpad** ì¹´ë“œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
3.  ì¹´ë“œ ìš°ì¸¡ í•˜ë‹¨ì˜ **ì  ì„¸ ê°œ(â‹®) ë©”ë‰´**ë¥¼ ëˆ„ë¥´ê³  **'ë””ë²„ê·¸ ë¡œê¹… í™œì„±í™”'**ë¥¼ í´ë¦­í•©ë‹ˆë‹¤.
4.  ë¬¸ì œë¥¼ ì¬í˜„(ì˜ˆ: ì¡°ëª… ì‘ë™)í•œ í›„, ë‹¤ì‹œ ê°™ì€ ë©”ë‰´ì—ì„œ **'ë””ë²„ê·¸ ë¡œê¹… ë¹„í™œì„±í™”'**ë¥¼ ëˆ„ë¥´ë©´ ë¡œê·¸ íŒŒì¼ì´ ì¦‰ì‹œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.

### ë°©ë²• 2: ì§„ë‹¨ ë°ì´í„° ì¶”ì¶œ (JSON)
ë¡œê·¸ì™€ ë³„ë„ë¡œ í˜„ì¬ ì‹œìŠ¤í…œì˜ ìˆ˜ì¹˜í™”ëœ ìƒíƒœë¥¼ ë³´ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
1.  ë°©ë²• 1ê³¼ ë™ì¼í•˜ê²Œ **Kocom Wallpad** ì¹´ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤.
2.  **'ì§„ë‹¨ ì •ë³´ ë‹¤ìš´ë¡œë“œ'** ë©”ë‰´ë¥¼ í´ë¦­í•˜ë©´ í˜„ì¬ ì—°ê²° ìƒíƒœ, í ë¶€í•˜, ë°œê²¬ëœ ì—”í‹°í‹° ìˆ˜ ë“±ì´ í¬í•¨ëœ JSON íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.

### ë°©ë²• 3: YAML ì„¤ì •ì„ í†µí•œ ì˜êµ¬ í™œì„±í™”
íŠ¹ì • ëª¨ë“ˆì˜ ë¡œê·¸ë§Œ ì§‘ì¤‘ì ìœ¼ë¡œ ë³´ê³  ì‹¶ì„ ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.
```yaml
logger:
  default: info
  logs:
    # ì „ì²´ ë¡œê·¸ (ê°€ì¥ ê¶Œì¥)
    custom_components.kocom_wallpad: debug
    # íŠ¹ì • ëª¨ë“ˆë§Œ ë³´ê¸° (ì„ íƒ ì‚¬í•­)
    # custom_components.kocom_wallpad.transport: debug  # í†µì‹ /ì„¸ì…˜ ê´€ë ¨
    # custom_components.kocom_wallpad.controller: debug # íŒ¨í‚· íŒŒì‹± ê´€ë ¨
    # custom_components.kocom_wallpad.gateway: debug    # ì œì–´ ë¡œì§ ê´€ë ¨
```

### ë¡œê·¸ í™•ì¸ ë°©ë²•
*   **ì‹¤ì‹œê°„ í™•ì¸:** `ì„¤ì • > ì‹œìŠ¤í…œ > ë¡œê·¸` ë©”ë‰´ì—ì„œ ìš°ì¸¡ í•˜ë‹¨ **'ì „ì²´ ë¡œê·¸ ë¡œë“œ'** ë²„íŠ¼ í´ë¦­.
*   **íŒŒì¼ í™•ì¸:** í™ˆì–´ì‹œìŠ¤í„´íŠ¸ ì„¤ì • í´ë”(`config/`) ë‚´ì˜ `home-assistant.log` íŒŒì¼ í™•ì¸.

---

## ğŸ“œ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

Copyright (c) 2024 wknight1