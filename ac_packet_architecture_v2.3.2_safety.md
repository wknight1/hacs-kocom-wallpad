# [기술 문서] Kocom 조명 제어 안전성 및 조회 로직 아키텍처 (v2.3.2)

이 문서는 v2.3.2 버전에서 수정된 **조명 제어 안전성(Safety)** 및 **패시브 조회(Passive Query)** 설계를 다룹니다.

---

### 1. 문제: 재연결 시 조명 일괄 점등 (The 'Ghost Light' Incident)

v2.3.1 이하 버전에서 네트워크가 끊겼다가 복구될 때, 집안의 모든 조명이 갑자기 켜지는 현상이 보고되었습니다.

#### **원인 분석**
1.  **재연결 트리거:** 네트워크가 복구되면 `_force_discovery()`가 실행되어 모든 조명에 대해 상태 조회(`query`)를 시도합니다.
2.  **잘못된 패킷 생성:** 기존 `_generate_switch` 함수는 `query` 액션일 때도 Home Assistant가 기억하고 있는 '마지막 상태'를 패킷에 담았습니다.
    *   만약 사용자가 마지막으로 조명을 켜둔 상태였다면(HA State: ON), 조회 패킷의 데이터 영역에 `0xFF`(ON)를 담아 보냈습니다.
3.  **월패드의 오해:** Kocom 월패드(특히 롯데캐슬 등)는 `0x00` 커맨드에 `0xFF` 데이터가 포함되면 이를 **"조명을 켜라"**는 명령으로 해석합니다.
4.  **결과:** 단순 상태 확인 목적의 패킷이 실제 제어 명령으로 동작하여 조명을 켜버림.

---

### 2. 해결책: 패시브 조회 (Passive Query) 도입

v2.3.2에서는 조명 상태 조회 시 **데이터 페이로드를 무조건 0으로 비우는** 정책을 적용했습니다.

| 구분 | 기존 (v2.3.1 이전) | 개선 (v2.3.2) | 비고 |
| :--- | :--- | :--- | :--- |
| **Query Logic** | `Target State` 반영 | **`0x00` (Zeroed)** | 상태를 강제하지 않음 |
| **Payload Example** | `AA 55 ... FF ...` (ON) | `AA 55 ... 00 ...` | 순수 조회 패킷 |
| **Behavior** | 상태 확인 + 강제 동기화 | **상태 확인 Only** | 안전성 확보 |

#### **코드 변경 사항 (`controller.py`)**
```python
def _generate_switch(self, key, action, data):
    if action == "query":
        return data  # data is initialized to all zeros
    # ... (기존 제어 로직) ...
```

---

### 3. 안전성 검증 (Safety Verification)

이 변경으로 인해 다음과 같은 시나리오에서 안전성이 보장됩니다.

1.  **공유기 재부팅:** 재연결 후 Discovery가 실행되어도 조명은 켜지지 않고 현재 상태만 갱신됩니다.
2.  **HA 재시작:** 부팅 시 초기 조회 과정에서 불필요한 제어 명령이 전송되지 않습니다.
3.  **데이터 무결성:** 월패드가 응답하는 실제 상태값(`ACK`)을 신뢰하여 HA 상태를 업데이트합니다.

v2.3.2는 **"관찰하되 개입하지 않는다(Observe, don't intervene)"**는 원칙을 조명 제어 로직에 적용하여 시스템의 신뢰성을 크게 높였습니다.
