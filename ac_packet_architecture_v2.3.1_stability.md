# [기술 문서] Kocom 세션 안정화 및 정밀 진단 아키텍처 (v2.3.1)

이 문서는 v2.3.1 버전에서 강화된 **세션 유지 최적화** 및 **안정성 지표(Stability Metrics)** 설계를 다룹니다.

---

### 1. 배경: 공격적인 세션 종료 (Aggressive Session Termination)

v2.3.0의 로그 분석 결과, 일부 환경(EW11 특정 설정 또는 공유기 특성)에서 약 30초 내외의 유휴 시간이 발생하면 원격 호스트가 세션을 종료(EOF)하는 현상이 빈번하게 관찰되었습니다.

*   **관찰된 현상:** 25초 주기의 하트비트 사이의 미세한 지연 시간으로 인해 세션이 끊기고 즉시 재연결됨.
*   **영향:** 제어 자체는 자가 치유 로직으로 성공하지만, 불필요한 로그가 누적되고 첫 명령의 반응 속도가 소폭 저하됨.

---

### 2. 해결책: 하트비트 및 상태 관리 최적화

v2.3.1에서는 다음과 같은 개선 사항을 적용했습니다.

#### **2.1 하트비트 간격 단축 (20s)**
*   EW11의 표준 30초 타임아웃보다 충분히 앞선 **20초** 주기로 하트비트를 전송합니다.
*   가장 안전한 가스밸브 조회(0x02) 패킷을 사용하므로 비프음 등 부작용이 없습니다.

#### **2.2 세션 상태 관리 정교화**
*   `AsyncConnection`의 `close()` 메서드가 중복 호출되어 발생하는 로그 노이즈를 제거했습니다.
*   연결 수립 시마다 `reconnect_count`를 증가시켜 진단 데이터에서 세션 안정성을 수치로 확인할 수 있게 했습니다.

---

### 3. 진단 지표 활용 가이드

이제 진단 정보(JSON)에서 다음 필드를 통해 고가용성을 판단할 수 있습니다.

| 필드 | 의미 | 분석 방법 |
| :--- | :--- | :--- |
| `reconnect_count` | 누적 재연결 횟수 | 부팅 후 시간 대비 횟수가 너무 높으면 네트워크 불안정 의심 |
| `recv_idle_since` | 마지막 수신 후 경과 시간 | 30분 이상 지속 시 `Unavailable` 전환 징후 |
| `tx_queue_size` | 명령 대기열 크기 | 0보다 크면 명령 처리가 지연되고 있는 상태 |

v2.3.1은 실제 로그 기반의 피드백 루프를 통해 시스템을 더욱 견고하게 만들었습니다.
